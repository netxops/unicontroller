# Agent V2 开发路线图

## 当前状态 ✅

### 已完成功能
- ✅ 基础架构搭建（分层架构、依赖注入）
- ✅ 服务注册和发现（etcd 集成）
- ✅ 与 Controller 集成（服务发现、状态同步）
- ✅ gRPC 服务框架（Package、Command、Health、Metrics 服务）
- ✅ gRPC 反射 API（支持 grpcurl 测试）
- ✅ 健康检查系统（HTTP/TCP/进程/脚本检查器）
- ✅ 自动恢复框架
- ✅ 指标收集和上报（系统指标、服务指标、Prometheus 导出、Controller 上报）
- ✅ 日志管理框架（日志收集、轮转、清理）
- ✅ 服务依赖管理（拓扑排序、循环依赖检测）
- ✅ 服务生命周期管理（systemd 支持、直接启动方式）
- ✅ 配置管理系统（viper、YAML、热重载）
- ✅ 进程用户切换功能
- ✅ Command 服务 PAUSE/RESUME 功能

## 下一步开发计划

### 阶段一：核心功能完善（优先级：高）🔥

#### 1. 配置管理完善 ✅
**目标**：从配置文件读取所有参数，而不是硬编码

- [x] 实现配置加载（使用 viper）
- [x] 从配置文件读取 etcd 地址和前缀
- [x] 从配置文件读取 agent-code、端口等参数
- [x] 从配置文件读取 systemd user unit 设置
- [x] 支持配置热重载（使用 fsnotify）

**状态**：已完成

#### 2. Package 服务功能完善 ✅
**目标**：实现所有 Package 服务的方法

- [x] 实现 `GetConfigs` - 获取服务配置
- [x] 实现 `ApplyConfigs` - 应用配置变更
- [x] 实现 `GetRecentLogs` - 获取服务日志
- [x] 完善 `PackageList` - 计算运行时长

**状态**：已完成

#### 3. 服务发现和自动注册 ✅
**目标**：自动发现工作目录中的服务并注册

- [x] 实现服务发现（扫描 package.json 文件）
- [x] 自动注册发现的服务
- [x] 支持服务更新

**状态**：已完成

### 阶段二：运维功能增强（优先级：中）📊

#### 4. 指标收集完善 ✅
**目标**：完整实现系统和服务的指标收集

- [x] 完善服务指标收集（进程 CPU、内存、goroutine）
- [x] 实现指标上报到 Controller（Prometheus Remote Write）
- [x] 实现 Prometheus 指标导出（HTTP /metrics 端点）
- [x] 支持系统指标和服务指标上报
- [x] 失败重试机制

**状态**：已完成

#### 5. 日志管理完善 ✅
**目标**：完整的日志收集和管理功能

- [x] 实现日志文件读取和查询（`QueryLogs`）
- [x] 实现日志流式传输（`StreamLogs`）
- [x] 实现日志轮转管理
- [x] 支持日志过滤和搜索（关键词、级别、时间范围）

**状态**：已完成

#### 6. 健康检查和自动恢复完善 ✅
**目标**：完善健康检查和自动恢复机制

- [x] 实现定期健康检查调度（`HealthCoordinator`）
- [x] 完善自动恢复策略（指数退避、最大重试）
- [x] 实现健康状态通知（`HealthNotifier`）
- [x] 支持自定义健康检查脚本
- [x] 实现健康检查历史记录（`HealthHistory`）

**状态**：已完成

### 阶段三：高级功能（优先级：中低）🚀

#### 7. gRPC 服务扩展 ✅
**目标**：实现 Health 和 Metrics gRPC 服务

- [x] 定义 HealthService proto
- [x] 实现 HealthService gRPC 方法（GetHealthStatus、ListHealthStatuses、GetHealthHistory）
- [x] 定义 MetricsService proto
- [x] 实现 MetricsService gRPC 方法（GetSystemMetrics、GetServiceMetrics、ListServiceMetrics）

**状态**：已完成

#### 8. 直接启动方式支持 ✅
**目标**：支持非 systemd 的服务启动方式

- [x] 实现直接启动（fork/exec）
- [x] 实现进程管理（PID 文件、信号处理）
- [x] 支持后台运行和日志重定向
- [x] 支持进程用户切换

**状态**：已完成

#### 9. 服务依赖管理增强 ✅
**目标**：完善服务依赖处理

- [x] 实现依赖拓扑排序
- [x] 支持依赖启动顺序
- [x] 实现依赖故障处理
- [x] 支持循环依赖检测

**状态**：已完成

### 阶段四：测试和优化（优先级：中）🧪

#### 10. 单元测试和集成测试
**目标**：提高代码质量和可靠性

- [x] 为服务管理器编写单元测试
- [x] 为依赖管理器编写单元测试（8个测试用例）
- [x] 为指标收集器编写单元测试（包含 GetAllServiceMetrics）
- [x] 为指标上报器编写单元测试（5个测试用例）
- [ ] 为进程管理器编写单元测试
- [ ] 为服务发现编写单元测试
- [ ] 为健康检查器编写单元测试
- [ ] 编写集成测试（与 Controller 交互）
- [ ] 编写端到端测试

**状态**：部分完成，需要继续完善

#### 11. 性能优化
**目标**：优化性能和资源使用

- [ ] 性能分析和优化
- [ ] 内存使用优化
- [ ] 并发处理优化
- [ ] 指标收集性能优化

**预计时间**：2-3 天

### 阶段五：文档和部署（优先级：中）📚

#### 12. 文档完善
**目标**：完善用户和开发者文档

- [ ] API 文档（Swagger/OpenAPI）
- [ ] 部署指南
- [ ] 故障排查指南
- [ ] 最佳实践文档
- [ ] 迁移指南（从原 Agent 迁移）

**预计时间**：2-3 天

#### 13. 部署和打包
**目标**：简化部署流程

- [ ] 创建 systemd service 文件
- [ ] 创建 Docker 镜像
- [ ] 创建安装脚本
- [ ] 创建升级脚本

**预计时间**：2-3 天

## 推荐开发顺序

### 短期（1-2 周）
1. **配置管理完善** - 这是基础，其他功能都依赖它
2. **Package 服务功能完善** - 核心功能，直接影响可用性
3. **服务发现和自动注册** - 提升用户体验

### 中期（2-4 周）
4. **指标收集完善** - 运维监控的重要功能
5. **日志管理完善** - 问题排查的关键功能
6. **健康检查和自动恢复完善** - 提高系统可靠性

### 长期（1-2 月）
7. **gRPC 服务扩展** - 增强功能
8. **直接启动方式支持** - 扩展兼容性
9. **测试和优化** - 提高质量
10. **文档和部署** - 便于使用

## 关键里程碑

- **Milestone 1**: 核心功能可用（配置管理 + Package 服务完善）
- **Milestone 2**: 运维功能完整（指标 + 日志 + 健康检查）
- **Milestone 3**: 生产就绪（测试 + 优化 + 文档）

## 技术债务

需要关注的技术债务：
- [ ] 日志流式传输未实现
- [ ] 日志管理增强功能未实现（查询、搜索、过滤）
- [ ] 健康检查增强功能未实现（通知机制、历史记录）
- [ ] ProcessManager 和 ServiceDiscovery 测试覆盖不足
- [ ] 集成测试和端到端测试未实现

## 下一步行动

### 立即开始（本周）
1. **补充单元测试** - 为 ProcessManager 和 ServiceDiscovery 编写测试
2. **实现日志流式传输** - 实时日志查看功能
3. **实现日志管理增强** - 日志查询、搜索、过滤功能
4. **实现健康检查增强** - 通知机制和历史记录
5. **编写集成测试** - 验证系统集成

### 本周目标
- 完成 ProcessManager 和 ServiceDiscovery 单元测试
- 实现日志流式传输功能
- 开始实现日志管理增强功能

## 注意事项

1. **向后兼容**：确保与 Controller 的通信协议兼容
2. **错误处理**：完善错误处理和日志记录
3. **性能考虑**：注意指标收集和健康检查的性能影响
4. **安全性**：注意配置和日志的敏感信息处理
5. **可观测性**：确保有足够的日志和指标用于问题排查

