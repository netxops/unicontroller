# 策略自动化测试使用指南

## 概述

本工具提供了完整的策略自动化测试功能，可以：
1. 从 NodeMap 自动生成测试数据
2. 使用生成的测试数据执行自动化测试
3. 生成详细的测试报告（控制台和HTML格式）

## 使用步骤

### 1. 生成测试数据

首先，运行程序生成测试数据：

```bash
cd pkg/nodemap/example/usg_example
go run main.go
```

或者编译后运行：

```bash
go build -o run_tests ./pkg/nodemap/example/usg_example
./run_tests
```

程序会：
- 加载或创建 NodeMap（从 `nm.json` 或 `config.yaml`）
- 遍历所有防火墙节点
- 提取每个节点的最后50个策略
- 为每个策略生成4种测试场景的测试数据：
  - **CONTAINED**: 被当前策略包含（完全子集）
  - **EXACT_MATCH**: 等于当前策略
  - **NEW_TEST**: 全新测试（修改了至少两个维度）
  - **PARTIAL_MATCH**: 部分匹配（源、目、服务中有两者相同，第三者不同）
- 将测试数据保存为 `{节点名}_policy_tests.yaml` 文件

### 2. 运行自动化测试

使用 `test` 参数运行自动化测试：

```bash
go run main.go test
```

或者：

```bash
./run_tests test
```

程序会：
- 自动查找所有 `*_policy_tests.yaml` 文件
- 解析每个测试用例
- 使用 NodeMap 的 `MakeTemplates` 方法执行策略匹配测试
- 验证结果是否符合预期（根据测试场景）
- 生成测试报告

### 3. 查看测试报告

测试完成后，会生成两种格式的报告：

#### 控制台报告

在控制台输出中，您会看到：
- 每个测试文件的详细报告
- 汇总报告（所有测试文件的统计）
- 失败的测试用例详情

示例输出：
```
========== 测试报告: NJ-JiS-E24-FW-1.RP.Edu8000E_policy_tests.yaml ==========
总测试数: 311
通过: 298
失败: 13
通过率: 95.82%
总耗时: 2m30s

按场景统计:
  CONTAINED: 78
  EXACT_MATCH: 78
  NEW_TEST: 78
  PARTIAL_MATCH: 77
```

#### HTML 报告

程序会自动生成 `policy_test_report.html` 文件，包含：
- 汇总信息（总测试数、通过率等）
- 每个测试文件的详细结果表格
- 失败的测试用例及其错误信息

在浏览器中打开 `policy_test_report.html` 查看详细报告。

## 测试场景说明

### CONTAINED（被包含）
- **期望结果**: 应该匹配到策略
- **说明**: 测试用例的源地址、目标地址、服务都是原策略的子集

### EXACT_MATCH（完全匹配）
- **期望结果**: 应该匹配到策略
- **说明**: 测试用例与原策略完全相同

### NEW_TEST（全新测试）
- **期望结果**: 不应该匹配到策略
- **说明**: 测试用例修改了至少两个维度（源、目、服务），是一个全新的策略

### PARTIAL_MATCH（部分匹配）
- **期望结果**: 通常不应该完全匹配
- **说明**: 测试用例中源、目、服务有两个相同，第三个不同

## 测试数据文件格式

测试数据文件是 YAML 格式，每个测试用例包含：

```yaml
# 测试用例 1: 子集测试: 源=192.168.1.0/24, 目=10.0.0.0/24, 服务=tcp:80
policy:
  destination: "10.0.0.0/24"
  source: "192.168.1.0/24"
  service:
    protocol: "tcp"
    port: "80"
```

## 配置要求

确保以下文件存在：

1. **config.yaml**: 包含设备配置信息
2. **nm.json**: NodeMap 的序列化文件（可选，如果不存在会自动创建）
3. **设备配置文件**: 在 `config.yaml` 中指定的 `file_path` 对应的配置文件

## 常见问题

### Q: 测试失败率很高怎么办？
A: 检查以下几点：
- 确保 NodeMap 已正确加载（检查 `nm.json` 是否存在且有效）
- 检查测试数据中的地址和服务格式是否正确
- 查看失败测试用例的错误信息，了解具体原因

### Q: 如何只测试特定的测试文件？
A: 可以临时重命名或移动其他测试文件，只保留要测试的文件。

### Q: 如何调整测试场景的期望结果？
A: 修改 `shouldMatch` 函数中的逻辑，根据您的需求调整不同场景的期望匹配结果。

### Q: 测试运行很慢怎么办？
A: 可以：
- 减少每个设备的策略数量（修改 `maxPoliciesPerDevice` 常量）
- 减少每个策略的测试用例数量（修改 `maxTestCasesPerPolicy` 常量）
- 只测试部分测试文件

## 扩展功能

### 添加新的测试场景

1. 在 `TestScenario` 常量中添加新场景
2. 在 `generateTestDataForPolicy` 中添加生成逻辑
3. 在 `shouldMatch` 中定义期望结果
4. 在 `extractScenario` 中添加识别逻辑

### 自定义测试报告

修改 `generateHTMLReport` 函数可以自定义HTML报告的样式和内容。

## 注意事项

1. 确保 Redis 服务正在运行（如果使用缓存功能）
2. 确保有足够的磁盘空间存储测试数据和报告
3. 大量测试用例可能需要较长时间运行
4. 建议在测试前备份 `nm.json` 文件

