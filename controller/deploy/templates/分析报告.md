# è®¾å¤‡é‡‡é›†é…ç½®ç³»ç»Ÿåˆ†ææŠ¥å‘Š

## ä¸€ã€å½“å‰ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### 1.1 ç›®å½•ç»“æ„
```
deploy/templates/
â”œâ”€â”€ {manufacturer}/          # å‚å•†ç›®å½•ï¼ˆå¦‚ cisco, dell, huaweiï¼‰
â”‚   â””â”€â”€ {platform}/          # å¹³å°ç›®å½•ï¼ˆå¦‚ ios, ubuntu, centosï¼‰
â”‚       â”œâ”€â”€ config.yaml      # ä¸»é…ç½®æ–‡ä»¶ï¼ˆå®šä¹‰pipelineï¼‰
â”‚       â”œâ”€â”€ alive/           # å­˜æ´»æ£€æŸ¥é…ç½®
â”‚       â”œâ”€â”€ collect/         # é‡‡é›†é…ç½®
â”‚       â”œâ”€â”€ parse/           # è§£æé…ç½®
â”‚       â”œâ”€â”€ transform/       # è½¬æ¢é…ç½®
â”‚       â”œâ”€â”€ snmp/            # SNMPå¤„ç†é…ç½®
â”‚       â”œâ”€â”€ textfsm/         # TextFSMæ¨¡æ¿
â”‚       â”œâ”€â”€ join/            # æ•°æ®åˆå¹¶é…ç½®
â”‚       â””â”€â”€ version_map.yaml # ç‰ˆæœ¬æ˜ å°„
â”œâ”€â”€ mode_configs/            # æ¨¡å¼é…ç½®
â””â”€â”€ default_hub_config.yaml  # é»˜è®¤Hubé…ç½®
```

### 1.2 Pipelineé˜¶æ®µç±»å‹
- **AliveCheck**: è®¾å¤‡å­˜æ´»æ£€æŸ¥
- **Collect**: æ•°æ®é‡‡é›†ï¼ˆSSH/SNMP/TELNETï¼‰
- **Parse**: æ•°æ®è§£æï¼ˆæ­£åˆ™æå–ï¼‰
- **Transform**: æ•°æ®è½¬æ¢ï¼ˆè¡¨è¾¾å¼å¼•æ“ï¼‰
- **SnmpProcess**: SNMPæ•°æ®å¤„ç†
- **TextFSM**: TextFSMæ¨¡æ¿è§£æ
- **Join**: æ•°æ®åˆå¹¶ï¼ˆå¤šè¡¨å…³è”ï¼‰

### 1.3 é…ç½®ç¤ºä¾‹ï¼ˆå½“å‰ç³»ç»Ÿï¼‰

```yaml
# cisco/ios/config.yaml
pipeline:
  - type: AliveCheck
    config:
      aliveCheckConfig:
        aliveCheckItem:
          $include: alive/ssh_alive_check.yaml
  - type: Collect
    config:
      collectConfig:
        collectItems:
          - $include: collect/snmp_version.yaml
          - $include: collect/snmp_iftable.yaml
  - type: SnmpProcess
    config:
      snmpProcessConfig:
        processItems:
          - $include: snmp/snmp_version_process.yaml
  - type: Transform
    config:
      transformConfig:
        transformItems:
          - $include: transform/description_to_version.yaml
```

## äºŒã€ç”¨æˆ·æä¾›çš„"attentions"é…ç½®æ ¼å¼åˆ†æ

### 2.1 é…ç½®ç»“æ„
```yaml
- deviceCollect:
    manufacturer: Dell
    platform: Ubuntu
    target:
      - type: "IsAlive"
        combinations:
          - name: sshAliveCheck
            collectMethod: SSH
            stages:
              - name: AliveCheck
                method: sshAliveCheck
      - type: "NetworkDeviceVersion"
        combinations:
          - name: sshVersion
            collectMethod: SSH
            stages:
              - name: Collect
                method: sshVersion
              - name: Parse
                method: VersionExtract
```

### 2.2 å…³é”®ç‰¹å¾
1. **å£°æ˜å¼é…ç½®**: ä»¥ç›®æ ‡æ•°æ®ç±»å‹ï¼ˆtarget typeï¼‰ä¸ºä¸­å¿ƒ
2. **ç»„åˆæ¨¡å¼**: é€šè¿‡combinationså®šä¹‰å¤šç§é‡‡é›†æ–¹æ³•
3. **é˜¶æ®µé“¾**: stageså®šä¹‰å¤„ç†æµç¨‹
4. **æ–¹æ³•æ˜ å°„**: methodå­—æ®µæ˜ å°„åˆ°å…·ä½“å®ç°

## ä¸‰ã€é—®é¢˜åˆ†æ

### 3.1 é…ç½®æ ¼å¼ä¸ç»Ÿä¸€ âš ï¸

**é—®é¢˜**:
- å½“å‰ç³»ç»Ÿä½¿ç”¨åŸºäºpipelineé˜¶æ®µçš„é…ç½®
- ç”¨æˆ·æä¾›çš„é…ç½®ä½¿ç”¨åŸºäºtargetç±»å‹çš„é…ç½®
- ä¸¤ç§æ ¼å¼æ— æ³•ç›´æ¥å¯¹åº”

**å½±å“**:
- é…ç½®ç»´æŠ¤å›°éš¾
- æ–°è®¾å¤‡ç±»å‹é…ç½®å¤æ‚
- ç¼ºä¹ç»Ÿä¸€çš„é…ç½®ç®¡ç†

### 3.2 é…ç½®é‡å¤ä¸¥é‡ âš ï¸âš ï¸

**é—®é¢˜**:
ä»ç”¨æˆ·æä¾›çš„é…ç½®å¯ä»¥çœ‹å‡ºï¼š
- Dell Ubuntu å’Œ Dell Centos é…ç½®å‡ ä¹å®Œå…¨ç›¸åŒ
- Cisco IOSã€Huawei USGã€Huawei HuaWei é…ç½®é«˜åº¦ç›¸ä¼¼
- H3C Comware å’Œ H3C SecPath é…ç½®å¤§éƒ¨åˆ†é‡å¤
- å¤šä¸ªå‚å•†çš„SNMPé‡‡é›†é…ç½®å®Œå…¨ä¸€è‡´

**ç¤ºä¾‹**:
```yaml
# ä»¥ä¸‹é…ç½®åœ¨å¤šä¸ªè®¾å¤‡ä¸­é‡å¤å‡ºç°ï¼š
- type: "NetworkDevicePorts"
  combinations:
    - name: snmpIftable
      collectMethod: SNMP
      stages:
        - name: Collect
          method: snmpIftable
        - name: SnmpProcess
          method: snmpIftableProcess
        - name: Collect
          method: snmpIpAddrEntry
        - name: SnmpProcess
          method: snmpIpAddrEntryProcess
        - name: Collect
          method: snmpIfHighSpeed
        - name: SnmpProcess
          method: snmpIfHighSpeedProcess
        - name: Join
          method: snmpDevicePorts
```

### 3.3 ç¼ºä¹é…ç½®æŠ½è±¡å’Œç»§æ‰¿ âš ï¸âš ï¸

**é—®é¢˜**:
- æ— æ³•å®šä¹‰åŸºç¡€é…ç½®æ¨¡æ¿
- æ— æ³•é€šè¿‡ç»§æ‰¿å‡å°‘é‡å¤
- ç‰ˆæœ¬å·®å¼‚éœ€è¦å®Œæ•´å¤åˆ¶é…ç½®

**å½±å“**:
- é…ç½®æ–‡ä»¶æ•°é‡åºå¤§
- ä¿®æ”¹éœ€è¦åŒæ­¥å¤šä¸ªæ–‡ä»¶
- å®¹æ˜“äº§ç”Ÿä¸ä¸€è‡´

### 3.4 æ–¹æ³•å‘½åä¸ä¸€è‡´ âš ï¸

**é—®é¢˜**:
- æœ‰äº›ä½¿ç”¨é©¼å³°å‘½åï¼š`sshAliveCheck`
- æœ‰äº›ä½¿ç”¨ä¸‹åˆ’çº¿ï¼š`snmp_iftable_process`
- å‘½åè§„åˆ™ä¸ç»Ÿä¸€

### 3.5 é˜¶æ®µç±»å‹æ˜ å°„ä¸æ¸…æ™° âš ï¸

**é—®é¢˜**:
- stagesä¸­çš„nameå­—æ®µï¼ˆAliveCheck, Collect, Parseç­‰ï¼‰ä¸pipelineçš„typeå¯¹åº”å…³ç³»ä¸æ˜ç¡®
- ç¼ºå°‘é˜¶æ®µæ‰§è¡Œé¡ºåºçš„æ˜ç¡®å®šä¹‰
- å¤šä¸ªstageså¦‚ä½•ç»„åˆæˆpipelineä¸æ¸…æ™°

### 3.6 é…ç½®éªŒè¯æœºåˆ¶ç¼ºå¤± âš ï¸

**é—®é¢˜**:
- æ— æ³•éªŒè¯é…ç½®çš„å®Œæ•´æ€§
- æ— æ³•æ£€æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ¨
- æ— æ³•éªŒè¯æ•°æ®æµä¾èµ–å…³ç³»

### 3.7 é…ç½®åŠ¨æ€æ€§ä¸è¶³ âš ï¸

**é—®é¢˜**:
- æ— æ³•æ ¹æ®è®¾å¤‡ç‰ˆæœ¬åŠ¨æ€é€‰æ‹©é…ç½®
- æ— æ³•æ ¹æ®ç¯å¢ƒå˜é‡è°ƒæ•´é…ç½®
- é…ç½®å˜æ›´éœ€è¦é‡å¯æœåŠ¡

## å››ã€æ”¹è¿›å»ºè®®

### 4.1 ç»Ÿä¸€é…ç½®æ ¼å¼

**å»ºè®®**: å»ºç«‹é…ç½®è½¬æ¢å±‚ï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ï¼š
1. **å£°æ˜å¼é…ç½®**ï¼ˆç”¨æˆ·æä¾›çš„æ ¼å¼ï¼‰- é¢å‘ä¸šåŠ¡
2. **æ‰§è¡Œå¼é…ç½®**ï¼ˆå½“å‰pipelineæ ¼å¼ï¼‰- é¢å‘æ‰§è¡Œ

**å®ç°**:
```yaml
# å£°æ˜å¼é…ç½®ï¼ˆç”¨æˆ·å‹å¥½ï¼‰
deviceCollect:
  manufacturer: Dell
  platform: Ubuntu
  targets:
    - type: NetworkDeviceVersion
      methods: [sshVersion, sshHostname]
      stages: [Collect, Parse]

# è‡ªåŠ¨è½¬æ¢ä¸ºæ‰§è¡Œå¼é…ç½®
pipeline:
  - type: Collect
    config:
      collectConfig:
        collectItems:
          - name: sshVersion
            method: SSH
            target: ...
```

### 4.2 å¼•å…¥é…ç½®ç»§æ‰¿æœºåˆ¶

**å»ºè®®**: ä½¿ç”¨YAMLçš„é”šç‚¹å’Œåˆ«åï¼Œæˆ–å®ç°é…ç½®ç»§æ‰¿ç³»ç»Ÿ

**ç¤ºä¾‹**:
```yaml
# base_network_device.yaml (åŸºç¡€é…ç½®)
baseNetworkDevice: &base
  targets:
    - type: NetworkDevicePorts
      combinations:
        - name: snmpIftable
          collectMethod: SNMP
          stages: [...]

# cisco/ios/config.yaml
deviceCollect:
  manufacturer: Cisco
  platform: IOS
  <<: *base  # ç»§æ‰¿åŸºç¡€é…ç½®
  targets:
    - type: NeighborCdp  # æ·»åŠ Ciscoç‰¹æœ‰é…ç½®
      combinations: [...]
```

### 4.3 å»ºç«‹é…ç½®æ¨¡æ¿åº“

**å»ºè®®**: æŒ‰é‡‡é›†æ–¹æ³•åˆ†ç±»å»ºç«‹æ¨¡æ¿åº“

```
templates/
â”œâ”€â”€ methods/              # æ–¹æ³•æ¨¡æ¿åº“
â”‚   â”œâ”€â”€ snmp/
â”‚   â”‚   â”œâ”€â”€ iftable.yaml
â”‚   â”‚   â”œâ”€â”€ version.yaml
â”‚   â”‚   â””â”€â”€ arp.yaml
â”‚   â””â”€â”€ ssh/
â”‚       â”œâ”€â”€ version.yaml
â”‚       â””â”€â”€ lldp.yaml
â”œâ”€â”€ targets/             # ç›®æ ‡ç±»å‹æ¨¡æ¿
â”‚   â”œâ”€â”€ NetworkDeviceVersion.yaml
â”‚   â”œâ”€â”€ NetworkDevicePorts.yaml
â”‚   â””â”€â”€ SwitchArpTable.yaml
â””â”€â”€ devices/             # è®¾å¤‡é…ç½®ï¼ˆå¼•ç”¨æ¨¡æ¿ï¼‰
    â””â”€â”€ cisco/
        â””â”€â”€ ios/
            â””â”€â”€ config.yaml
```

### 4.4 å®ç°é…ç½®åˆå¹¶ç­–ç•¥

**å»ºè®®**: æ”¯æŒå¤šç§åˆå¹¶ç­–ç•¥
- **è¦†ç›–**: å­é…ç½®å®Œå…¨è¦†ç›–çˆ¶é…ç½®
- **åˆå¹¶**: åˆå¹¶æ•°ç»„å’Œæ˜ å°„
- **è¿½åŠ **: åœ¨æ•°ç»„æœ«å°¾è¿½åŠ 

### 4.5 å»ºç«‹é…ç½®éªŒè¯ç³»ç»Ÿ

**å»ºè®®**: 
1. **é™æ€éªŒè¯**: é…ç½®åŠ è½½æ—¶éªŒè¯
   - æ–¹æ³•æ˜¯å¦å­˜åœ¨
   - å­—æ®µä¾èµ–å…³ç³»
   - æ•°æ®ç±»å‹åŒ¹é…

2. **åŠ¨æ€éªŒè¯**: è¿è¡Œæ—¶éªŒè¯
   - æ•°æ®æµå®Œæ•´æ€§
   - é˜¶æ®µæ‰§è¡Œé¡ºåº
   - è¾“å‡ºæ ¼å¼æ­£ç¡®æ€§

### 4.6 ç»Ÿä¸€å‘½åè§„èŒƒ

**å»ºè®®**: å»ºç«‹å‘½åè§„èŒƒæ–‡æ¡£
- **æ–¹æ³•å**: ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”ï¼Œæ ¼å¼ï¼š`{protocol}_{resource}_{action}`
  - ç¤ºä¾‹ï¼š`snmp_iftable_collect`, `ssh_version_parse`
- **é…ç½®å**: ä½¿ç”¨é©¼å³°å‘½å
  - ç¤ºä¾‹ï¼š`sshVersionCollect`, `snmpIftableProcess`

### 4.7 å®ç°é…ç½®ç‰ˆæœ¬ç®¡ç†

**å»ºè®®**: 
1. æ”¯æŒé…ç½®ç‰ˆæœ¬å·
2. æ”¯æŒé…ç½®å›æ»š
3. è®°å½•é…ç½®å˜æ›´å†å²

### 4.8 ä¼˜åŒ–é…ç½®ç»„ç»‡ç»“æ„

**å»ºè®®**: æŒ‰åŠŸèƒ½è€Œéè®¾å¤‡ç±»å‹ç»„ç»‡é…ç½®

```
templates/
â”œâ”€â”€ common/              # é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ snmp_methods/    # SNMPæ–¹æ³•åº“
â”‚   â””â”€â”€ ssh_methods/     # SSHæ–¹æ³•åº“
â”œâ”€â”€ targets/             # ç›®æ ‡ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ version.yaml
â”‚   â”œâ”€â”€ ports.yaml
â”‚   â””â”€â”€ arp.yaml
â””â”€â”€ devices/            # è®¾å¤‡ç‰¹å®šé…ç½®ï¼ˆæœ€å°åŒ–ï¼‰
    â””â”€â”€ cisco/
        â””â”€â”€ ios/
            â””â”€â”€ overrides.yaml  # ä»…åŒ…å«å·®å¼‚é…ç½®
```

## äº”ã€å…·ä½“æ”¹è¿›æ–¹æ¡ˆ

### 5.1 é…ç½®è½¬æ¢å™¨

åˆ›å»ºä¸€ä¸ªé…ç½®è½¬æ¢å™¨ï¼Œå°†å£°æ˜å¼é…ç½®è½¬æ¢ä¸ºæ‰§è¡Œå¼é…ç½®ï¼š

```go
type ConfigConverter struct {
    methodRegistry map[string]MethodConfig
    stageRegistry  map[string]StageConfig
}

func (c *ConfigConverter) Convert(declarative DeviceCollectConfig) (*DeviceConfig, error) {
    // 1. è§£ætargetç±»å‹
    // 2. æŸ¥æ‰¾å¯¹åº”çš„combinations
    // 3. å±•å¼€stagesä¸ºpipeline
    // 4. è§£ææ–¹æ³•å¼•ç”¨
    // 5. ç”Ÿæˆæœ€ç»ˆé…ç½®
}
```

### 5.2 é…ç½®ç»§æ‰¿ç³»ç»Ÿ

```yaml
# å®šä¹‰åŸºç¡€é…ç½®
base_config:
  common_targets:
    - type: NetworkDevicePorts
      template: snmp_ports_template

# è®¾å¤‡é…ç½®ç»§æ‰¿å¹¶æ‰©å±•
device_config:
  extends: base_config
  manufacturer: Cisco
  platform: IOS
  additional_targets:
    - type: NeighborCdp
      template: cdp_template
```

### 5.3 é…ç½®éªŒè¯å·¥å…·

```go
type ConfigValidator struct {
    schema Schema
}

func (v *ConfigValidator) Validate(config DeviceCollectConfig) []ValidationError {
    // 1. éªŒè¯å¿…éœ€å­—æ®µ
    // 2. éªŒè¯æ–¹æ³•å­˜åœ¨æ€§
    // 3. éªŒè¯æ•°æ®æµä¾èµ–
    // 4. éªŒè¯ç±»å‹åŒ¹é…
}
```

## å…­ã€å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ ğŸ”´
1. **ç»Ÿä¸€é…ç½®æ ¼å¼** - å»ºç«‹é…ç½®è½¬æ¢å±‚
2. **é…ç½®ç»§æ‰¿æœºåˆ¶** - å‡å°‘é‡å¤é…ç½®
3. **é…ç½®éªŒè¯** - é¿å…è¿è¡Œæ—¶é”™è¯¯

### ä¸­ä¼˜å…ˆçº§ ğŸŸ¡
4. **é…ç½®æ¨¡æ¿åº“** - æé«˜å¤ç”¨æ€§
5. **å‘½åè§„èŒƒç»Ÿä¸€** - æé«˜å¯ç»´æŠ¤æ€§
6. **é…ç½®ç»„ç»‡ç»“æ„ä¼˜åŒ–** - ä¾¿äºç®¡ç†

### ä½ä¼˜å…ˆçº§ ğŸŸ¢
7. **é…ç½®ç‰ˆæœ¬ç®¡ç†** - é•¿æœŸç»´æŠ¤
8. **åŠ¨æ€é…ç½®** - é«˜çº§ç‰¹æ€§

## ä¸ƒã€æ€»ç»“

å½“å‰ç³»ç»Ÿè™½ç„¶å®ç°äº†åŸºæœ¬çš„è®¾å¤‡é‡‡é›†åŠŸèƒ½ï¼Œä½†åœ¨é…ç½®ç®¡ç†æ–¹é¢å­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š

1. **é…ç½®é‡å¤ä¸¥é‡** - ç›¸åŒé…ç½®åœ¨å¤šå¤„é‡å¤å®šä¹‰
2. **ç¼ºä¹æŠ½è±¡æœºåˆ¶** - æ— æ³•é€šè¿‡ç»§æ‰¿å‡å°‘é‡å¤
3. **æ ¼å¼ä¸ç»Ÿä¸€** - å£°æ˜å¼ä¸æ‰§è¡Œå¼é…ç½®æ··ç”¨
4. **éªŒè¯ä¸è¶³** - ç¼ºå°‘é…ç½®éªŒè¯æœºåˆ¶

å»ºè®®ä¼˜å…ˆå®æ–½é…ç½®è½¬æ¢å™¨å’Œç»§æ‰¿æœºåˆ¶ï¼Œè¿™å°†æ˜¾è‘—å‡å°‘é…ç½®é‡å¤ï¼Œæé«˜ç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚

