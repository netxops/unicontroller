# 配置对比与改进示例

## 一、配置格式对比

### 1.1 当前系统配置格式（执行式）

```yaml
# cisco/ios/config.yaml
pipeline:
  - type: AliveCheck
    config:
      aliveCheckConfig:
        aliveCheckItem:
          $include: alive/ssh_alive_check.yaml
  
  - type: Collect
    config:
      collectConfig:
        collectItems:
          - $include: collect/snmp_version.yaml
          - $include: collect/snmp_iftable.yaml
  
  - type: SnmpProcess
    config:
      snmpProcessConfig:
        processItems:
          - $include: snmp/snmp_version_process.yaml
  
  - type: Transform
    config:
      transformConfig:
        transformItems:
          - $include: transform/description_to_version.yaml
```

**特点**:
- ✅ 执行流程清晰
- ✅ 阶段顺序明确
- ❌ 配置冗长
- ❌ 需要理解pipeline概念

### 1.2 用户提供的配置格式（声明式）

```yaml
- deviceCollect:
    manufacturer: Cisco
    platform: IOS
    target:
      - type: "IsAlive"
        combinations:
          - name: sshAliveCheck
            collectMethod: SSH
            stages:
              - name: AliveCheck
                method: sshAliveCheck
      - type: "NetworkDeviceVersion"
        combinations:
          - name: sysVersion
            collectMethod: SNMP
            stages:
              - name: Collect
                method: sysVersion
              - name: SnmpProcess
                method: sysVersionProcess
              - name: Transform
                method: descriptionToVersion
```

**特点**:
- ✅ 面向业务目标
- ✅ 配置简洁
- ✅ 易于理解
- ❌ 需要转换为执行格式
- ❌ 阶段执行顺序不明确

## 二、配置重复问题示例

### 2.1 问题：相同配置在多处重复

**Dell Ubuntu 配置**:
```yaml
- deviceCollect:
    manufacturer: Dell
    platform: Ubuntu
    target:
      - type: "IsAlive"
        combinations:
          - name: sshAliveCheck
            collectMethod: SSH
            stages:
              - name: AliveCheck
                method: sshAliveCheck
      - type: "NetworkDeviceVersion"
        combinations:
          - name: sshVersion
            collectMethod: SSH
            stages:
              - name: Collect
                method: sshVersion
              - name: Parse
                method: VersionExtract
```

**Dell Centos 配置**（几乎完全相同）:
```yaml
- deviceCollect:
    manufacturer: Dell
    platform: Centos
    target:
      - type: "IsAlive"
        combinations:
          - name: sshAliveCheck
            collectMethod: SSH
            stages:
              - name: AliveCheck
                method: sshAliveCheck
      - type: "NetworkDeviceVersion"
        combinations:
          - name: sshVersion
            collectMethod: SSH
            stages:
              - name: Collect
                method: sshVersion
              - name: Parse
                method: VersionExtract
```

**问题**: 两个配置99%相同，只有platform字段不同！

### 2.2 改进方案：使用配置继承

```yaml
# base/dell_server.yaml (基础配置)
baseDellServer: &dell_base
  manufacturer: Dell
  target:
    - type: "IsAlive"
      combinations:
        - name: sshAliveCheck
          collectMethod: SSH
          stages:
            - name: AliveCheck
              method: sshAliveCheck
    - type: "NetworkDeviceVersion"
      combinations:
        - name: sshVersion
          collectMethod: SSH
          stages:
            - name: Collect
              method: sshVersion
            - name: Parse
              method: VersionExtract

# dell/ubuntu/config.yaml
deviceCollect:
  <<: *dell_base
  platform: Ubuntu

# dell/centos/config.yaml
deviceCollect:
  <<: *dell_base
  platform: Centos
```

## 三、SNMP配置重复问题

### 3.1 问题：NetworkDevicePorts配置在多个设备中重复

以下配置在 **Cisco IOS、Dptech FWNFV、Huawei USG、Huawei HuaWei、H3C Comware、H3C SecPath、Sangfor SangforOS、Ruijie Ruijie** 中完全相同：

```yaml
- type: "NetworkDevicePorts"
  combinations:
    - name: snmpIftable
      collectMethod: SNMP
      stages:
        - name: Collect
          method: snmpIftable
        - name: SnmpProcess
          method: snmpIftableProcess
        - name: Collect
          method: snmpIpAddrEntry
        - name: SnmpProcess
          method: snmpIpAddrEntryProcess
        - name: Collect
          method: snmpIfHighSpeed
        - name: SnmpProcess
          method: snmpIfHighSpeedProcess
        - name: Join
          method: snmpDevicePorts
```

### 3.2 改进方案：提取为通用模板

```yaml
# templates/targets/network_device_ports.yaml
name: NetworkDevicePorts
type: NetworkDevicePorts
combinations:
  - name: snmpIftable
    collectMethod: SNMP
    stages:
      - name: Collect
        method: snmpIftable
      - name: SnmpProcess
        method: snmpIftableProcess
      - name: Collect
        method: snmpIpAddrEntry
      - name: SnmpProcess
        method: snmpIpAddrEntryProcess
      - name: Collect
        method: snmpIfHighSpeed
      - name: SnmpProcess
        method: snmpIfHighSpeedProcess
      - name: Join
        method: snmpDevicePorts

# cisco/ios/config.yaml
deviceCollect:
  manufacturer: Cisco
  platform: IOS
  target:
    - $include: ../../templates/targets/network_device_ports.yaml
    - type: "NeighborCdp"  # Cisco特有配置
      combinations: [...]
```

## 四、阶段映射问题

### 4.1 问题：stages到pipeline的映射不清晰

**用户配置中的stages**:
```yaml
stages:
  - name: Collect
    method: sysVersion
  - name: SnmpProcess
    method: sysVersionProcess
  - name: Transform
    method: descriptionToVersion
```

**问题**:
- 这些stages是顺序执行还是并行执行？
- 如何组合成pipeline？
- 数据如何在stages之间传递？

### 4.2 改进方案：明确阶段类型和执行顺序

```yaml
# 改进后的配置格式
stages:
  - type: Collect
    name: sysVersion
    method: sysVersion
    output: sysVersionData
  
  - type: SnmpProcess
    name: sysVersionProcess
    method: sysVersionProcess
    input: sysVersionData
    output: sysVersionProcessed
  
  - type: Transform
    name: descriptionToVersion
    method: descriptionToVersion
    input: sysVersionProcessed
    output: versionResult
```

## 五、配置验证问题

### 5.1 问题：缺少配置验证

当前配置可能存在的问题：
1. 方法不存在：`method: nonExistentMethod`
2. 数据流断裂：前一个stage的输出字段不存在
3. 类型不匹配：期望string但得到array
4. 循环依赖：stage A依赖B，B依赖A

### 5.2 改进方案：配置验证器

```go
// 配置验证示例
type ConfigValidator struct {
    methodRegistry map[string]bool
    stageRegistry  map[string]StageInfo
}

func (v *ConfigValidator) Validate(config DeviceCollectConfig) []Error {
    errors := []Error{}
    
    // 1. 验证方法存在性
    for _, target := range config.Target {
        for _, combo := range target.Combinations {
            for _, stage := range combo.Stages {
                if !v.methodRegistry[stage.Method] {
                    errors = append(errors, Error{
                        Type: "METHOD_NOT_FOUND",
                        Message: fmt.Sprintf("Method %s not found", stage.Method),
                    })
                }
            }
        }
    }
    
    // 2. 验证数据流依赖
    // 3. 验证类型匹配
    // 4. 验证循环依赖
    
    return errors
}
```

## 六、完整改进示例

### 6.1 改进后的配置结构

```
templates/
├── base/                    # 基础配置模板
│   ├── dell_server.yaml
│   ├── network_device.yaml
│   └── snmp_device.yaml
├── methods/                 # 方法定义库
│   ├── snmp/
│   │   ├── iftable.yaml
│   │   ├── version.yaml
│   │   └── arp.yaml
│   └── ssh/
│       ├── version.yaml
│       └── lldp.yaml
├── targets/                 # 目标类型模板
│   ├── NetworkDeviceVersion.yaml
│   ├── NetworkDevicePorts.yaml
│   └── SwitchArpTable.yaml
└── devices/                 # 设备配置（最小化）
    ├── dell/
    │   ├── ubuntu/
    │   │   └── config.yaml  # 仅包含platform差异
    │   └── centos/
    │       └── config.yaml
    └── cisco/
        └── ios/
            └── config.yaml  # 仅包含Cisco特有配置
```

### 6.2 改进后的Dell配置示例

```yaml
# base/dell_server.yaml
baseDellServer:
  manufacturer: Dell
  commonTargets:
    - $include: ../targets/IsAlive.yaml
    - $include: ../targets/NetworkDeviceVersion.yaml
    - $include: ../targets/NetworkDeviceSerialTable.yaml
    - $include: ../targets/DeviceMeta.yaml

# dell/ubuntu/config.yaml
deviceCollect:
  extends: base/dell_server.yaml
  platform: Ubuntu

# dell/centos/config.yaml
deviceCollect:
  extends: base/dell_server.yaml
  platform: Centos
```

### 6.3 改进后的Cisco配置示例

```yaml
# base/network_device.yaml
baseNetworkDevice:
  commonTargets:
    - $include: ../targets/IsAlive.yaml
    - $include: ../targets/NetworkDeviceVersion.yaml
    - $include: ../targets/NetworkDevicePorts.yaml
    - $include: ../targets/SwitchArpTable.yaml

# cisco/ios/config.yaml
deviceCollect:
  extends: base/network_device.yaml
  manufacturer: Cisco
  platform: IOS
  additionalTargets:
    - type: "NeighborCdp"
      combinations:
        - name: cdp
          collectMethod: SNMP
          stages:
            - type: Collect
              method: snmpCdp
            - type: SnmpProcess
              method: snmpCdpProcess
    - type: "MacTable"
      combinations:
        - name: macTable
          collectMethod: SNMP
          stages:
            - type: Collect
              method: snmpMacTable
            - type: SnmpProcess
              method: snmpMacTableProcess
```

## 七、配置转换示例

### 7.1 声明式配置转执行式配置

**输入（声明式）**:
```yaml
deviceCollect:
  manufacturer: Cisco
  platform: IOS
  target:
    - type: "NetworkDeviceVersion"
      combinations:
        - name: sysVersion
          collectMethod: SNMP
          stages:
            - name: Collect
              method: sysVersion
            - name: SnmpProcess
              method: sysVersionProcess
            - name: Transform
              method: descriptionToVersion
```

**输出（执行式）**:
```yaml
pipeline:
  - type: Collect
    config:
      collectConfig:
        collectItems:
          - name: sysVersion
            method: SNMP
            target: 1.3.6.1.2.1.1
            dataType: "[]map[string]string"
  
  - type: SnmpProcess
    config:
      snmpProcessConfig:
        processItems:
          - name: sysVersionProcess
            inputField: sysVersion
            indexPositions: [1]
            classifierPositions: [0]
  
  - type: Transform
    config:
      transformConfig:
        transformItems:
          - name: descriptionToVersion
            dataType: map[string]string
            mappings:
              - inputField: sysVersionProcess#description
                outputField: version
                regex: "Version (\\S+)"
```

## 八、总结

通过以上改进方案，可以实现：

1. **配置减少80%+** - 通过继承和模板复用
2. **维护成本降低** - 修改一处，所有引用处自动更新
3. **配置更清晰** - 声明式配置易于理解
4. **验证更完善** - 静态和动态验证确保配置正确性
5. **扩展更容易** - 新设备只需定义差异部分

